<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Decomposition API | Speckle Docs</title>
    <meta name="generator" content="VuePress 1.8.2">
    <script src="/scripts/scroll-to-hash.js"></script>
    <meta name="description" content="Documentation on everything Speckle">
    <meta name="theme-color" content="#0480FB">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.df7ac8e6.css" as="style"><link rel="preload" href="/assets/js/app.99a85e76.js" as="script"><link rel="preload" href="/assets/js/4.4326cdb2.js" as="script"><link rel="preload" href="/assets/js/40.d2261fc4.js" as="script"><link rel="prefetch" href="/assets/js/10.3e7ac9b8.js"><link rel="prefetch" href="/assets/js/11.a4694f2f.js"><link rel="prefetch" href="/assets/js/12.c114fb3d.js"><link rel="prefetch" href="/assets/js/13.7cc92742.js"><link rel="prefetch" href="/assets/js/14.f4163000.js"><link rel="prefetch" href="/assets/js/15.2efb9a44.js"><link rel="prefetch" href="/assets/js/16.21572a9c.js"><link rel="prefetch" href="/assets/js/17.0ca52ce1.js"><link rel="prefetch" href="/assets/js/18.156d8e4d.js"><link rel="prefetch" href="/assets/js/19.ae2b9c8c.js"><link rel="prefetch" href="/assets/js/20.ee5275bb.js"><link rel="prefetch" href="/assets/js/21.60e9f828.js"><link rel="prefetch" href="/assets/js/22.9780a091.js"><link rel="prefetch" href="/assets/js/23.3af4e7e3.js"><link rel="prefetch" href="/assets/js/24.0b6908e4.js"><link rel="prefetch" href="/assets/js/25.15884d28.js"><link rel="prefetch" href="/assets/js/26.4182a715.js"><link rel="prefetch" href="/assets/js/27.f73e931d.js"><link rel="prefetch" href="/assets/js/28.526514f8.js"><link rel="prefetch" href="/assets/js/29.254ef804.js"><link rel="prefetch" href="/assets/js/3.2c817222.js"><link rel="prefetch" href="/assets/js/30.7b9c4b8b.js"><link rel="prefetch" href="/assets/js/31.0ae384c7.js"><link rel="prefetch" href="/assets/js/32.ff7dc8a3.js"><link rel="prefetch" href="/assets/js/33.22ee2056.js"><link rel="prefetch" href="/assets/js/34.32233c9e.js"><link rel="prefetch" href="/assets/js/35.87aa89ee.js"><link rel="prefetch" href="/assets/js/36.a1e3d380.js"><link rel="prefetch" href="/assets/js/37.121a0a1c.js"><link rel="prefetch" href="/assets/js/38.6270b359.js"><link rel="prefetch" href="/assets/js/39.72767cb8.js"><link rel="prefetch" href="/assets/js/41.3b2b05a8.js"><link rel="prefetch" href="/assets/js/42.c88af68f.js"><link rel="prefetch" href="/assets/js/43.47abbed9.js"><link rel="prefetch" href="/assets/js/44.125e48f0.js"><link rel="prefetch" href="/assets/js/45.1c8bf8c8.js"><link rel="prefetch" href="/assets/js/46.e76c532e.js"><link rel="prefetch" href="/assets/js/47.19a7f421.js"><link rel="prefetch" href="/assets/js/48.33e9e938.js"><link rel="prefetch" href="/assets/js/49.c89f1432.js"><link rel="prefetch" href="/assets/js/5.6a902ace.js"><link rel="prefetch" href="/assets/js/50.35f05f89.js"><link rel="prefetch" href="/assets/js/51.f1a6f631.js"><link rel="prefetch" href="/assets/js/52.e7cf1987.js"><link rel="prefetch" href="/assets/js/53.5137e2c4.js"><link rel="prefetch" href="/assets/js/54.f9641ffa.js"><link rel="prefetch" href="/assets/js/55.3e64c05b.js"><link rel="prefetch" href="/assets/js/56.3a1b3c96.js"><link rel="prefetch" href="/assets/js/57.0255fe1f.js"><link rel="prefetch" href="/assets/js/58.78203d8e.js"><link rel="prefetch" href="/assets/js/59.e0afe630.js"><link rel="prefetch" href="/assets/js/6.42ae08b8.js"><link rel="prefetch" href="/assets/js/60.d648178f.js"><link rel="prefetch" href="/assets/js/61.ba653bbd.js"><link rel="prefetch" href="/assets/js/62.25d813a4.js"><link rel="prefetch" href="/assets/js/63.f9688f43.js"><link rel="prefetch" href="/assets/js/64.d6f115ed.js"><link rel="prefetch" href="/assets/js/65.36f31357.js"><link rel="prefetch" href="/assets/js/7.a2af4118.js"><link rel="prefetch" href="/assets/js/8.34516b02.js"><link rel="prefetch" href="/assets/js/9.d41b359b.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.4b331d06.js">
    <link rel="stylesheet" href="/assets/css/0.styles.df7ac8e6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/logo-docs.png" alt="Speckle Docs" class="logo"> <span class="site-name can-hide">Speckle Docs</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  User Guide
</a></div><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  Developer Docs
</a></div><div class="nav-item"><a href="https://speckle.systems" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Speckle Website
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://speckle.systems/getstarted/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Get Started
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/specklesystems/speckle-docs/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  User Guide
</a></div><div class="nav-item"><a href="/dev/" class="nav-link router-link-active">
  Developer Docs
</a></div><div class="nav-item"><a href="https://speckle.systems" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Speckle Website
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://speckle.systems/getstarted/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Get Started
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/specklesystems/speckle-docs/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Developer Docs 👩‍💻</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/dev/architecture.html" class="sidebar-link">Architecture</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Core Concepts</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/base.html" class="sidebar-link">The Base Object</a></li><li><a href="/dev/decomposition.html" aria-current="page" class="active sidebar-link">Decomposition API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/decomposition.html#preamble" class="sidebar-link">Preamble</a></li><li class="sidebar-sub-header"><a href="/dev/decomposition.html#blobs-and-trees" class="sidebar-link">Blobs and Trees</a></li><li class="sidebar-sub-header"><a href="/dev/decomposition.html#decomposing" class="sidebar-link">Decomposing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/decomposition.html#strongly-typed-detachment" class="sidebar-link">Strongly Typed Detachment</a></li><li class="sidebar-sub-header"><a href="/dev/decomposition.html#dynamic-detachment" class="sidebar-link">Dynamic Detachment</a></li></ul></li><li class="sidebar-sub-header"><a href="/dev/decomposition.html#recomposing" class="sidebar-link">Recomposing</a></li><li class="sidebar-sub-header"><a href="/dev/decomposition.html#chunking" class="sidebar-link">Chunking</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/dev/decomposition.html#problem" class="sidebar-link">Problem</a></li><li class="sidebar-sub-header"><a href="/dev/decomposition.html#solutions" class="sidebar-link">Solutions</a></li><li class="sidebar-sub-header"><a href="/dev/decomposition.html#first-port-of-call-optimise-the-list-property-🧪" class="sidebar-link">First port of call: Optimise the list property 🧪</a></li><li class="sidebar-sub-header"><a href="/dev/decomposition.html#second-port-of-call-use-the-chunkable-attribute-🆕" class="sidebar-link">Second port of call: Use the Chunkable Attribute 🆕</a></li></ul></li><li class="sidebar-sub-header"><a href="/dev/decomposition.html#summary" class="sidebar-link">Summary</a></li></ul></li><li><a href="/dev/kits.html" class="sidebar-link">Kits</a></li><li><a href="/dev/transports.html" class="sidebar-link">Transports</a></li><li><a href="/dev/apps-auth.html" class="sidebar-link">Apps &amp; Auth</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Advanced Concepts</span> <!----></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>.NET SDK</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/dotnet.html" class="sidebar-link">Introduction</a></li><li><a href="/dev/objects.html" class="sidebar-link">Objects Kit</a></li><li><a href="/dev/connectors-dev.html" class="sidebar-link">Writing Your Own connector</a></li><li><a href="/dev/kits-dev.html" class="sidebar-link">Writing Your Own Kit</a></li><li><a href="/dev/transports-dev.html" class="sidebar-link">Writing Your Own Transport</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Python SDK</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/python.html" class="sidebar-link">Introduction</a></li><li><a href="/dev/py-examples.html" class="sidebar-link">Examples</a></li><li><a href="/dev/py-sample.html" class="sidebar-link">Tutorial: Simple Dashboard</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Javascript SDK</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/js.html" class="sidebar-link">Introduction</a></li><li><a href="/dev/viewer.html" class="sidebar-link">Using our embeddable 3D viewer</a></li><li><a href="/dev/js-app-script.html" class="sidebar-link">Using Google Apps Scripts</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Server API &amp; Apps</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/dev/server-api.html" class="sidebar-link">Introduction</a></li><li><a href="/dev/server-graphql-api.html" class="sidebar-link">GraphQL API</a></li><li><a href="/dev/server-rest-api.html" class="sidebar-link">REST API</a></li><li><a href="/dev/server-webhooks.html" class="sidebar-link">Webhooks</a></li><li><a href="/dev/server-setup.html" class="sidebar-link">Deploying a Server - DigitalOcean Marketplace App</a></li><li><a href="/dev/server-manualsetup.html" class="sidebar-link">Deploying a Server - manual setup</a></li><li><a href="/dev/tokens.html" class="sidebar-link">Personal Access Tokens</a></li><li><a href="/dev/apps.html" class="sidebar-link">Creating Your Own App</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="decomposition-api"><a href="#decomposition-api" class="header-anchor">#</a> Decomposition API</h1> <p>This post was originally part of the Making Speckle 2.0 series of posts on the community forum, it's been adapted as part of our dev docs. Check out <a href="https://speckle.community/t/core-2-0-decomposition-api/911" target="_blank" rel="noopener noreferrer">the original on our forum<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>!</p> <h2 id="preamble"><a href="#preamble" class="header-anchor">#</a> Preamble</h2> <p>This page covers how Speckle deals with the structure and composition of design data. Please note that currently examples are only in C#, equivalent implementations are available in our other SDKs.</p> <h2 id="blobs-and-trees"><a href="#blobs-and-trees" class="header-anchor">#</a> Blobs and Trees</h2> <p>Design and construction data is mostly relational: <strong>built elements link to each other.</strong> Despite this, there is no canonical way of structuring it.
How do they relate to each other? Well, it depends!</p> <p><img src="https://speckle.community/uploads/default/optimized/1X/cb099e4d3a8553053869d791f0ce1fcaebca3c7a_2_690x295.png" alt=""></p> <p>For example, a <code>Site</code> object may contain one or more <code>Building</code> objects. These, in turn, may contain one more <code>Levels</code>, and each of these <code>Levels</code> may contain some <code>Walls</code>, <code>Floor</code> and <code>Beam</code> elements. Or, those <code>Building</code> objects may each individually reference the same <code>Site</code>. Within the <code>Building</code> object, there's all the <code>Walls</code> and <code>Beams</code>, and each of them, rather than being grouped under a <code>Level</code>, they individually reference a specific <code>Level</code>.</p> <p>In order to solve this, we've taken a good look at how git, the ubiquitous version control system, works. Git operates with two object types: blobs and trees. Blobs represent files, and an important characteristic is that they are immutable - just like objects are in Speckle. Trees represent folders, and they are used to track the hierarchy of the folder structure of your repository.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>If you think this analogy hints to more, you're right: Speckle is becoming a fully fledged version control system for design data. Keep an eye out 😎</p></div> <p>As opposed to Git, that deals with data structured on your hard drive, Speckle deals with data structured in memory. In Speckle, an object is, at the same time, both a blob (data) and a tree (its subcomponents). There are two separate, yet interweaved, problems (and their corollaries) that I'll now address:</p> <ul><li>How to decompose an object? <em>(Corollary: how to recompose an object?)</em></li> <li>How to serialise, transport and store that decomposed object? <em>(Corollary: how to retrieve and deserialise an object?)</em></li></ul> <h2 id="decomposing"><a href="#decomposing" class="header-anchor">#</a> Decomposing</h2> <p>There is no right or wrong way to structure design data. Different applications operate with different models, different use-cases require different hierarchies, different disciplines and professionals operate with differently structured ontologies.</p> <p>Speckle now has a mechanism by which, in the process of specifying an object - either via a strongly typed Kit, or via dynamic properties - developers (and end-users) can decide what gets decomposed and what doesn't.</p> <h3 id="strongly-typed-detachment"><a href="#strongly-typed-detachment" class="header-anchor">#</a> Strongly Typed Detachment</h3> <p>It works, in the case of strongly typed properties, by adding the Speckle specific attribute <code>[DetachProperty]</code> on the properties you want to store as references, rather than within the object itself.</p> <p>For example, let's take an imaginary set of classes:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Building</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Base</span></span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DetachProperty</span></span><span class="token punctuation">]</span> <span class="token comment">// this attribute tells Speckle to store the value of the Site separately.</span>
  <span class="token keyword">public</span> <span class="token return-type class-name">Site</span> Site <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Level<span class="token punctuation">&gt;</span></span> Levels <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">public</span> Owner <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Level</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Base</span></span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> height <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">3.2</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> baseElevation <span class="token punctuation">{</span><span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DetachProperty</span></span><span class="token punctuation">]</span>
  <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Base<span class="token punctuation">&gt;</span></span> Elements <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token comment">// The actual walls, floors, columns, etc.</span>
<span class="token punctuation">}</span>

<span class="token comment">// Define a site globally</span>
<span class="token class-name"><span class="token keyword">var</span></span> mySite <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Site</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Reference the same site in both buildings.</span>
buildingA<span class="token punctuation">.</span>Site <span class="token operator">=</span> mySite<span class="token punctuation">;</span>
buildingB<span class="token punctuation">.</span>Site <span class="token operator">=</span> mySite<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>When an instance of the Building class gets saved, the <code>Site</code> will be stored separately. If two Buildings share the same <code>Site</code>, it will be stored only once, and each instance of the <code>Building</code> class will hold a reference to the same <code>Site</code>.</p> <p>In our example, each Level can hold, in a <em>detachable</em> property, all its walls, beams, ducts, pipes, furniture, and other built elements. Consequently, each of these elements will be individually accessible from the storage layer, and will maintain topological unity. Why is this important? Let's imagine a building with a series of levels separated by floor slabs. <strong>The slab between two levels pertains to which level: the bottom one, or the top one?</strong></p> <p><img src="https://speckle.community/uploads/default/original/1X/3ea9d660024d5f3545933133165737e063fa87d5.png" alt=""></p> <h3 id="dynamic-detachment"><a href="#dynamic-detachment" class="header-anchor">#</a> Dynamic Detachment</h3> <p>Let's illustrate this through an example that also demonstrates how dynamically added properties can be detached. We'll assume that we will dynamically set <code>topSlab</code> and <code>bottomSlab</code> properties to each level in our imaginary object model:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">// We're grossly simplyfing in this example. Here are our two building levels:</span>
<span class="token class-name"><span class="token keyword">var</span></span> level_1<span class="token punctuation">,</span> level_2<span class="token punctuation">;</span>

<span class="token comment">// The philosophical slab instance. Does it belong to level 1 or level 2?</span>
<span class="token class-name"><span class="token keyword">var</span></span> slab_between_1_and_2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Slab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Well, it belongs to both! Notice the &quot;@&quot; characther at the beginning of</span>
<span class="token comment">// the dynamic property assignment - it's the Speckle convention for &quot;detaching&quot;</span>
<span class="token comment">// dynamically added properties.</span>
level_1<span class="token punctuation">[</span><span class="token string">&quot;@topSlab&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> slab_between_1_and_2<span class="token punctuation">;</span>
level_2<span class="token punctuation">[</span><span class="token string">&quot;@bottomSlab&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> slab_between_1_and_2<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Because we've prepended the property name with an &quot;@&quot; symbol, Speckle will now &quot;detach&quot; it. Consequently, once stored, both level one and two will now hold a reference to a single slab! Beyond storage efficiency - the slab is only stored once - <strong>this approach gives us the freedom to structure data however is best and, simultaneously, query, slice and dice it however we need to.</strong></p> <p>For example, let's assume you need to do a quantity takeoffs:</p> <ul><li>For each each individual level: specify the total surface area, including walls, ceilings, etc. Solution: simply retrieve each level individually!</li> <li>For the whole building: calculate the total volume of concrete that goes into the slabs. Solution: just query the building object for all the slabs!</li></ul> <p>Similarly, imagine you've written a script that does environmental analysis on a given level. The level can now be retrieved in its entirety - without juggling around to bring in the level above it too, just to get the ceiling out. Once the results are calculated, they can be stored in a detachable property on that specific level (e.g., <code>level_1[@&quot;solarComfortMeshWithColours&quot;] = analysisResultMesh;</code>). Later down the line in your workflow, one can could query for all the &quot;<code>solarComfortMeshWithColours</code>&quot; objects individually for each level, or, if needed, for the whole building.</p> <h2 id="recomposing"><a href="#recomposing" class="header-anchor">#</a> Recomposing</h2> <p>Recomposition of an object happens within the deserialisation process, and it's tightly integrated with the transport layer. The process, on the surface, is deceivingly simple. When you ask Speckle to receive a specific object, the process is as follows:</p> <ul><li>Speckle retrieves said object's &quot;blob&quot; (actually a JSON string representation of it),</li> <li>Next up, Speckle retrieves at all the reference tree of this object,</li> <li>Speckle proceeds to deserialise and re-compose the parent object, inserting in the place of references the actual referenced object.</li></ul> <p>Wether or not this sounds complicated, the exposed API is actually rather simple and the end result is that a decomposed object, when received back, will be identical with the original one - with all its parts in place 💥</p> <h2 id="chunking"><a href="#chunking" class="header-anchor">#</a> Chunking</h2> <h3 id="problem"><a href="#problem" class="header-anchor">#</a> Problem</h3> <p>Some list properties of various objects can get very large. Examples:</p> <ul><li>a Brep with many faces will have a Surfaces list prop containing 1000s of potentially heavy Surfaces.</li> <li>a mesh with 100k+ vertices and faces.</li></ul> <p>This results in a clunky (memory heavy) serialisation process and can be unsafe (read: cause borkages) due to memory limitations.</p> <h3 id="solutions"><a href="#solutions" class="header-anchor">#</a> Solutions</h3> <p>In order of preference. Note that they are not exclusive, and they build on top of each other:</p> <ul><li>First, optimise the list property so it's more lightweight</li> <li>Second, chunk the list property</li></ul> <h3 id="first-port-of-call-optimise-the-list-property-🧪"><a href="#first-port-of-call-optimise-the-list-property-🧪" class="header-anchor">#</a> First port of call: Optimise the list property 🧪</h3> <p>For example, you might be tempted to define a mesh like this:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Mesh</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Base</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span>Point<span class="token punctuation">&gt;</span></span> vertices <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>A much more efficient way is to define it like this:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Mesh</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Base</span></span>
<span class="token punctuation">{</span>
  <span class="token comment">// Typed array of 3</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">double</span><span class="token punctuation">&gt;</span></span> vertices <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>Instead of storing each individual vertex as a point, you store them in a typed array. Serialisation will be much faster and leaner.</p> <h3 id="second-port-of-call-use-the-chunkable-attribute-🆕"><a href="#second-port-of-call-use-the-chunkable-attribute-🆕" class="header-anchor">#</a> Second port of call: Use the <code>Chunkable</code> Attribute 🆕</h3> <p>In some cases you might be too lazy to actually optimise the storage of a list property, or it might be too convenient to use the class itself.</p> <p>Alternatively, you might still have a simple <code>List&lt;double&gt;</code> that expands to millions+ of items, like in the case of a very large mesh.</p> <p>In the cases above, the best way is to mark the property as <code>Chunkable</code> together with <code>[DetachProperty]</code>. This will tell the serialiser that it should split it into manageable chunks of items, the size of which you can control.</p> <p>Here's how that looks like currently in the mesh class:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Mesh</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Base</span></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DetachProperty</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Chunkable</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">// Chunks this array into batches of 20k numbers</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">double</span><span class="token punctuation">&gt;</span></span> vertices <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">double</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DetachProperty</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Chunkable</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">// Chunks this array into batches of 20k numbers</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> faces <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DetachProperty</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Chunkable</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">// Chunks this array into batches of 20k numbers</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> colors <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DetachProperty</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Chunkable</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token number">20000</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span> <span class="token comment">// Chunks this array into batches of 20k numbers</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">double</span><span class="token punctuation">&gt;</span></span> textureCoordinates <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">double</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">Potential Footguns</p> <p>The DetachProperty attribute by itself can be a performance footgun in some scenarios: for example, if you have a <code>List&lt;Point&gt;</code> that can grow really big and you mark it as detachable, without marking it as chunkable, each individual point in that list will be stored as a separate entity.</p> <p>This is bad: serialisation and deserialisation will take longer, and it essentially amounts to bad object model design (in speckle terms of course).</p></div> <h2 id="summary"><a href="#summary" class="header-anchor">#</a> Summary</h2> <p>End users and developers can now productively control the way they structure their design data through the decomposition mechanism. From the point of view of the future Speckle connectors, this will enable us to expose object model flexibility in a more elegant way than before to end users. As developers, Speckle gives you another powerful API on top of which you can scaffold your digital automation workflows.</p> <p>More importantly, this allows you to store arbitrary data structures (scaffolded on top of a <code>Base</code>) with Speckle, without paying any penalties: <strong>Speckle deals equally well with flat and nested data.</strong></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/specklesystems/speckle-docs/edit/main/dev/decomposition.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/1/2021, 7:20:52 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/dev/base.html" class="prev">
        The Base Object
      </a></span> <span class="next"><a href="/dev/kits.html">
        Kits
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.99a85e76.js" defer></script><script src="/assets/js/4.4326cdb2.js" defer></script><script src="/assets/js/40.d2261fc4.js" defer></script>
  </body>
</html>
